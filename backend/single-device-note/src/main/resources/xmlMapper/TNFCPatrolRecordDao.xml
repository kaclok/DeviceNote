<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- mapper namespace作用是：代码和xml进行关联 -->
<!-- https://blog.csdn.net/xu962336414/article/details/105624371 -->
<mapper namespace="com.smlj.singledevice_note.logic.o.vo.table.dao.TNFCPatrolRecordDao">
   <insert id="insert" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
      insert into nfcpatrol.t_nfcpatrol_record (rfid
         , dotime
         , person
         , content
         , errornum
         , deptid)
      values (#{item.rfid},
         #{item.dotime},
         #{item.person},
         #{item.content},
         ${item.errornum},
         #{item.deptid})
   </insert>

   <select id="queryAll" resultType="com.smlj.singledevice_note.logic.o.vo.table.entity.TNFCPatrolRecord">
      select * from nfcpatrol.t_nfcpatrol_record where 1 = 1
      <if test="queryByPerson != null and queryByPerson != ''">
         and person LIKE CONCAT('%', #{queryByPerson}, '%')
      </if>
      <if test="rfid != null and rfid != ''">
         and rfid = #{rfid}
      </if>
      <if test="queryBegin != null and queryBegin != ''">
         and #{queryBegin}::timestamp &lt;= (dotime::timestamp)
      </if>
      <if test="queryEnd != null and queryEnd != ''">
         and (dotime::timestamp) &lt;= #{queryEnd}::timestamp
      </if>
      order by dotime desc
   </select>

    <select id="querySeries" resultType="com.smlj.singledevice_note.logic.o.vo.logic_entity.nfcpatrol.VNFCPatrolLineRecord">
        WITH time_range AS (
            SELECT
            #{queryBegin}::timestamp AS begin_time,
            #{queryEnd}::timestamp AS end_time
        ),
        patrol_cycles AS (
            SELECT
            l.id AS line_id,
            l.linename,
            l.linenum,
            l.zzid,
            l.pointids,
            l.begintime,
            l.cycle,
            ARRAY_LENGTH(l.pointids, 1) AS total_points,
            gs.cycle_index AS cycle_index,
            GREATEST(l.begintime, trr.begin_time) + (gs.cycle_index * (l.cycle || ' hours')::interval) AS cycle_start_time,
            GREATEST(l.begintime, trr.begin_time) + ((gs.cycle_index + 1) * (l.cycle || ' hours')::interval) - interval '1 second'AS cycle_end_time
        FROM nfcpatrol.t_nfcpatrol_line l
        CROSS JOIN time_range trr
        CROSS JOIN LATERAL (
            SELECT generate_series(
                0,
                FLOOR(EXTRACT(EPOCH FROM (LEAST(trr.end_time, now()) - GREATEST(l.begintime, trr.begin_time))) / (l.cycle * 3600))::int
            ) AS cycle_index
        ) gs
        WHERE l.deleted = false
            AND ARRAY_LENGTH(l.pointids, 1) > 0
            AND (l.begintime::timestamp) &lt;= (trr.end_time::timestamp)
            <if test="zzIds != null and zzIds.size() > 0">
                AND zzid IN
                <foreach collection="zzIds" item="oneid" open="(" close=")" separator=",">
                    #{oneid}
                </foreach>
            </if>
        ),
        cycle_points AS (
            SELECT
                pc.line_id,
                pc.cycle_index,
                pc.cycle_start_time,
                pc.cycle_end_time,
                unnest(pc.pointids) AS point_id,
                pc.linename,
                pc.linenum,
                pc.zzid,
                pc.cycle,
                pc.total_points
            FROM patrol_cycles pc
        ),
        patrol_records AS (
            SELECT DISTINCT ON (cp.line_id, cp.cycle_index, r.rfid)
                cp.line_id,
                cp.cycle_index,
                r.rfid,
                r.person,
                r.deptid,
                r.dotime
            FROM cycle_points cp
            INNER JOIN nfcpatrol.t_nfcpatrol_record r
                ON r.rfid = cp.point_id
                AND r.dotime BETWEEN cp.cycle_start_time AND cp.cycle_end_time
            ORDER BY cp.line_id, cp.cycle_index, r.rfid, r.dotime DESC
        ),
        cycle_patrol_stats AS (
            SELECT
                pc.line_id,
                pc.linename,
                pc.linenum,
                pc.zzid,
                pc.cycle,
                pc.cycle_index,
                pc.cycle_start_time,
                pc.cycle_end_time,
                pc.total_points,
                COUNT(DISTINCT pr.rfid) AS checked_points,
                STRING_AGG(DISTINCT pr.person, ', ') AS patrol_persons,
                (ARRAY_AGG(pr.deptid ORDER BY pr.dotime DESC))[1] AS last_deptid
            FROM patrol_cycles pc
            LEFT JOIN patrol_records pr
                ON pr.line_id = pc.line_id
                AND pr.cycle_index = pc.cycle_index
            GROUP BY
                pc.line_id,
                pc.linename,
                pc.linenum,
                pc.zzid,
                pc.cycle,
                pc.cycle_index,
                pc.cycle_start_time,
                pc.cycle_end_time,
                pc.total_points
        ),
        final_result AS (
            SELECT
                cps.line_id as lineid,
                cps.linename,
                cps.zzid,
                cps.cycle,
                COALESCE(cps.last_deptid, '/') as deptid,
                COALESCE(d.name, '/') AS deptname,
                cps.cycle_start_time,
                cps.cycle_end_time,
                COALESCE(cps.patrol_persons, '/') AS patrol_person,
                cps.checked_points AS checked_cnt,
                cps.total_points AS total_cnt,
                CASE
                    WHEN CURRENT_TIMESTAMP BETWEEN cps.cycle_start_time AND cps.cycle_end_time THEN
                    CASE
                        WHEN cps.checked_points = 0 THEN 1
                        WHEN cps.checked_points &lt; cps.total_points THEN 2
                        ELSE 3
                    END

                    WHEN cps.cycle_end_time &lt; CURRENT_TIMESTAMP THEN
                        CASE
                        WHEN cps.checked_points = 0 THEN 4
                        WHEN cps.checked_points &lt; cps.total_points THEN 5
                        ELSE 3
                    END

                    ELSE 6
                END AS status
            FROM cycle_patrol_stats cps
            LEFT JOIN nfcpatrol.t_nfcpatrol_dept d
            ON d.id = cps.last_deptid
        )

        SELECT * FROM final_result
        <where>
            <if test="queryByStatus != null">
                status = ${queryByStatus}
            </if>
            <if test="queryByDeptIdArray != null and queryByDeptIdArray.size() > 0">
                AND (deptid IN
                <foreach collection="queryByDeptIdArray" item="oneid" open="(" separator="," close=")">
                    #{oneid}
                </foreach>
                OR deptid = '/')
            </if>
        </where>
        ORDER BY linename, cycle_start_time DESC
    </select>

   <select id="queryPointRecordCntOfLine" resultType="java.lang.Integer">
      SELECT COUNT(DISTINCT rfid) as cnt FROM nfcpatrol.t_nfcpatrol_record
      WHERE
         (rfid IN (SELECT UNNEST(pointids) FROM nfcpatrol.t_nfcpatrol_line WHERE id = ${lineid}))

      <if test="queryBegin != null and queryBegin != ''">
         and #{queryBegin}::timestamp &lt;= (dotime::timestamp)
      </if>
      <if test="queryEnd != null and queryEnd != ''">
         and (dotime::timestamp) &lt;= #{queryEnd}::timestamp
      </if>
   </select>
</mapper>
