<script>
    let requestId = WfForm.getBaseInfo().requestid.toString()
    let workflowId = WfForm.getBaseInfo().workflowid.toString()

    let currentUserId = WfForm.getGlobalStore().commonParam.currentUserid.toString()
    let currentUserName = WfForm.getGlobalStore().commonParam.lastname
    let createUserId = WfForm.getGlobalStore().commonParam.creater
    let currentMS = WfForm.getGlobalStore().commonParam.apiResultCacheKey

    let nodeType = WfForm.getGlobalStore().commonParam.nodetype

    console.error("requestId:" + requestId + "  workflowId: " + workflowId +
        "  currentUserId:" + currentUserId + "  currentUserName: " + currentUserName +
        "  createUserId:" + createUserId + "  currentMS: " + currentMS +
        "  nodeType:" + nodeType);

    let url = "http://10.8.54.24:7090/x/lp"
    url = "http://10.8.13.152:7090/x/lp"

    let isLp = false;
    let eptype = -1;
    let hasRecord = false;
    let hasArchiveTime = false;

    function postData(uri, urlencoded, onSuccess) {
        console.error(uri + " 请求参数:", urlencoded)

        let bodyData = urlencoded;
        if (urlencoded === null || urlencoded === undefined) {
            bodyData = new URLSearchParams()
        }

        fetch(uri, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "Accept": "*/*",
            },
            body: bodyData
        })
            .then(response => response.json())
            .then(data => {
                if (onSuccess !== null && typeof onSuccess === 'function') {
                    onSuccess(data)
                } else {
                    console.error(uri + " 请求成功:", data)
                }
            })
            .catch(error => console.error(uri + " 请求失败:", error));
    }

    function trySaveUser() {
        if (requestId === "-1") { // 创建节点
            let urlencoded = new URLSearchParams();
            urlencoded.append("_id", currentUserId);
            urlencoded.append("name", currentUserName);

            postData(url + "/storeUser", urlencoded, null)
        }
    }

    function fillCZP(urlencoded) {
        let czpz = null;
        let fieldId = WfForm.convertFieldNameToId("czpz");
        if (fieldId) {
            czpz = WfForm.getSelectShowName(fieldId);
        }
        urlencoded.append("czpz", czpz);

        let flr = null;
        fieldId = WfForm.convertFieldNameToId("flr");
        if (fieldId) {
            flr = WfForm.getBrowserShowName(fieldId);
        }
        urlencoded.append("flr", flr);

        let slr = null;
        fieldId = WfForm.convertFieldNameToId("slr");
        if (fieldId) {
            slr = WfForm.getBrowserShowName(fieldId);
        }
        urlencoded.append("slr", slr);

        let flsj = null;
        fieldId = WfForm.convertFieldNameToId("flsj");
        if (fieldId) {
            flsj = WfForm.getBrowserShowName(fieldId);
        }
        urlencoded.append("flsj", flsj);

        let czkssj = null;
        fieldId = WfForm.convertFieldNameToId("czkssj");
        if (fieldId) {
            czkssj = WfForm.getBrowserShowName(fieldId);
        }
        urlencoded.append("czkssj", czkssj);

        let czjssj = null;
        fieldId = WfForm.convertFieldNameToId("czjssj");
        if (fieldId) {
            czjssj = WfForm.getBrowserShowName(fieldId);
        }
        urlencoded.append("czjssj", czjssj);

        let czrw = null;
        fieldId = WfForm.convertFieldNameToId("czrw");
        if (fieldId) {
            czrw = WfForm.getFieldValue(fieldId);
        }
        urlencoded.append("czrw", czrw);
    }

    // 浏览、时间 用getBrowserShowName
    // 下拉菜单 用getSelectShowName
    // 普通文本 用getFieldValue
    function fillGZP(urlencoded) {
        let gzfzrjhr = null;
        let fieldId = WfForm.convertFieldNameToId("gzfzrjhr");
        if (fieldId) {
            gzfzrjhr = WfForm.getBrowserShowName(fieldId);
        }
        urlencoded.append("gzfzrjhr", gzfzrjhr);

        let dw = null;
        fieldId = WfForm.convertFieldNameToId("dw");
        if (fieldId) {
            dw = WfForm.getBrowserShowName(fieldId);
        }
        urlencoded.append("dw", dw);

        let jhgzsj = null;
        fieldId = WfForm.convertFieldNameToId("jhgzsj");
        if (fieldId) {
            jhgzsj = WfForm.getBrowserShowName(fieldId);
        }
        urlencoded.append("jhgzsj", jhgzsj);

        let gzddhdd1 = null;
        fieldId = WfForm.convertFieldNameToId("gzddhdd1");
        if (fieldId) {
            gzddhdd1 = WfForm.getFieldValue(fieldId);
        }
        urlencoded.append("gzddhdd1", gzddhdd1);

        let gznr1 = null;
        fieldId = WfForm.convertFieldNameToId("gznr1");
        if (fieldId) {
            gznr1 = WfForm.getFieldValue(fieldId);
        }
        urlencoded.append("gznr1", gznr1);
    }

    function fillRecord(urlencoded) {
        urlencoded.append("create_user_id", createUserId);
        urlencoded.append("submit_time", currentMS);

        // 操作票
        if (eptype === 1) {
            fillCZP(urlencoded);
        }
        // 工作票
        else if (eptype === 2) {
            fillGZP(urlencoded);
        }
    }

    function tryStoreRecord() {
        let urlencoded = new URLSearchParams();
        urlencoded.append("_id", requestId);
        urlencoded.append("workflow_id", workflowId);

        if (!hasRecord) {
            fillRecord(urlencoded);
            postData(url + "/storeRecord", urlencoded, null)
        } else if (nodeType === "3") {
            urlencoded.append("archive_time", currentMS);
            postData(url + "/storeRecordArchiveTime", urlencoded, null)
        }
    }

    function tryDeleteRecord() {
        let urlencoded = new URLSearchParams();
        urlencoded.append("_id", requestId);
        postData(url + "/deleteRecord", urlencoded, null)
    }

    WfForm.registerCheckEvent(WfForm.OPER_SUBMIT, function (callback) {
        trySaveUser();

        if (requestId !== "-1" && isLp) { // 非创建节点
            tryStoreRecord();
        }

        callback();
    });

    WfForm.registerCheckEvent(WfForm.OPER_SAVE, function (callback) {
        trySaveUser();

        callback();
    });

    WfForm.registerCheckEvent(WfForm.OPER_DELETE, function (callback) {
        tryDeleteRecord();

        callback();
    });

    function onGetInfo(data) {
        isLp = data.data.exists
        eptype = data.data.eptype
        hasRecord = data.data.hasRecord

        console.error("isLp: " + isLp + "  eptype:" + eptype + "  hasRecord:" + hasRecord);

        if (nodeType === "3") {
            tryStoreRecord();
        }
    }

    function doNext() {
        if (requestId === "-1") {
            return;
        }

        let urlencoded = new URLSearchParams();
        urlencoded.append("_id", requestId);
        urlencoded.append("workflow_id", workflowId);
        postData(url + "/getInfo", urlencoded, onGetInfo)
    }

    doNext();
</script>
